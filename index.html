<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Journal</title>
    <link rel="icon" type="image/x-icon" href="/images/Bag_Moon_Ball_SV_Sprite.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-color: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #e0e0e0; 
            --text-muted: #888;
            --border: #333; 
            --accent: #4a9eff;
            --date-accent: #fccf03; 
            --highlight: #252525;
            --toolbar-btn: #aaa; 
            --toolbar-hover: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-main); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: var(--card-bg); padding: 35px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 800px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .header-date { font-size: 1.35rem; font-weight: 800; color: var(--date-accent); text-align: right; }
        .filename-section { background: var(--highlight); padding: 12px 20px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); }
        .filename-section input { flex: 1; border: none; background: transparent; color: var(--text-main); outline: none; font-family: monospace; }
        h3 { margin: 30px 0 12px 0; font-size: 1rem; font-weight: 500; opacity: 0.9; }
        .editor { width: 100%; min-height: 110px; line-height: 1.7; outline: none; color: var(--text-main); white-space: pre-wrap; }
        .mood-box { padding: 20px; margin: 30px 0; text-align: center; border-top: 1px solid var(--border); }
        .mood-options { display: flex; justify-content: center; gap: 30px; font-size: 1.8rem; margin-top: 15px; }
        .mood-btn { cursor: pointer; opacity: 0.2; filter: grayscale(1); transition: 0.3s; }
        .mood-btn.selected { opacity: 1; filter: grayscale(0); transform: scale(1.25); }
        .button-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-save { background: var(--accent); color: #000; } 
        .btn-import { background: #333; color: var(--text-main); border: 1px solid var(--border); }
        .btn-reset { background: transparent; color: var(--text-muted); border: 1px solid var(--border); flex: 0.2; }
        .btn:hover { opacity: 0.8; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 style="margin:0;">Daily Journal</h2>
        <span id="currentDateDisplay" class="header-date"></span>
    </div>

    <div class="filename-section">
        <label style="color:var(--text-muted); font-size:0.8rem;">FILE</label>
        <input type="text" id="filename">
    </div>

    <h3>1. What are you grateful for today? What made you happy?</h3>
    <div class="editor-container">
        <div id="sec1" class="editor" contenteditable="true"></div>
    </div>

    <h3>2. What didn't make you feel great? Anything you want to improve on?</h3>
    <div id="sec2" class="editor" contenteditable="true"></div>

    <h3>3. Overall / Misc. thoughts</h3>
    <div id="sec3" class="editor" contenteditable="true"></div>

    <div class="mood-box">
        <div class="mood-options">
            <span class="mood-btn" data-mood="Terrible" onclick="selectMood(this, 'Terrible')">üò´</span>
            <span class="mood-btn" data-mood="Bad" onclick="selectMood(this, 'Bad')">üôÅ</span>
            <span class="mood-btn" data-mood="Okay" onclick="selectMood(this, 'Okay')">üòê</span>
            <span class="mood-btn" data-mood="Good" onclick="selectMood(this, 'Good')">üôÇ</span>
            <span class="mood-btn" data-mood="Great" onclick="selectMood(this, 'Great')">ü§©</span>
        </div>
        <input type="hidden" id="selectedMood" value="Not Specified">
    </div>

    <div class="button-group">
        <button class="btn btn-reset" onclick="resetForm()">Clear</button>
        <input type="file" id="fileInput" accept=".txt" onchange="handleFileUpload(event)">
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">Import .txt</button>
        <button class="btn btn-save" onclick="saveAsText()">Export to Text (.txt)</button>
    </div>
</div>

<script>
    window.onload = () => {
        const now = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('currentDateDisplay').innerText = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        document.getElementById('filename').value = `journal-${now.toISOString().split('T')[0]}`;
    };

    function selectMood(el, val) {
        document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedMood').value = `${el.innerText} (${val})`;
    }

    // New function to handle file upload
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseJournalText(content, file.name);
        };
        reader.readAsText(file);
    }

    // New function to parse the text and fill fields
    function parseJournalText(text, fullFileName) {
        try {
            // Set filename (minus extension)
            document.getElementById('filename').value = fullFileName.replace(/\.txt$/, '');

            // Extract Date
            const dateMatch = text.match(/Date: (.*)/);
            if (dateMatch) document.getElementById('currentDateDisplay').innerText = dateMatch[1];

            // Extract Mood and select emoji
            const moodMatch = text.match(/Mood: (.*) \((.*)\)/);
            if (moodMatch) {
                const moodLabel = moodMatch[2]; // e.g., "Great"
                const moodBtn = Array.from(document.querySelectorAll('.mood-btn')).find(b => b.getAttribute('data-mood') === moodLabel);
                if (moodBtn) selectMood(moodBtn, moodLabel);
            }

            // Extract Sections
            const sections = [
                "1. What are you grateful for today?",
                "2. What didn't make you feel great?",
                "3. Overall / Misc. thoughts"
            ];

            sections.forEach((title, index) => {
                const nextTitle = sections[index + 1] || null;
                let startIdx = text.indexOf(title) + title.length;
                let endIdx = nextTitle ? text.indexOf(nextTitle) : text.length;
                
                if (startIdx > title.length - 1) {
                    let sectionContent = text.substring(startIdx, endIdx).trim();
                    if (sectionContent === "(Empty)") sectionContent = "";
                    document.getElementById(`sec${index + 1}`).innerText = sectionContent;
                }
            });

            alert("File loaded successfully!");
        } catch (err) {
            console.error(err);
            alert("Error parsing file. Make sure it's a journal file exported from this app.");
        }
    }

    function resetForm() {
        if(confirm("Start fresh?")) {
            document.querySelectorAll('.editor').forEach(e => e.innerText = "");
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('selectedMood').value = "Not Specified";
            document.getElementById('fileInput').value = ""; // Clear file input
        }
    }

    function saveAsText() {
        const date = document.getElementById('currentDateDisplay').innerText;
        const mood = document.getElementById('selectedMood').value;
        const filename = document.getElementById('filename').value;

        const h = [
            "1. What are you grateful for today?",
            "2. What didn't make you feel great?",
            "3. Overall / Misc. thoughts"
        ];

        let textContent = `DAILY JOURNAL ENTRY\n`;
        textContent += `Date: ${date}\n`;
        textContent += `Mood: ${mood}\n`;
        textContent += `---------------------------\n\n`;

        [1, 2, 3].forEach((num, i) => {
            const content = document.getElementById(`sec${num}`).innerText;
            textContent += `${h[i]}\n`;
            textContent += `${content.trim() || "(Empty)"}\n\n`;
        });

        const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
        saveAs(blob, `${filename}.txt`);
    }
</script>
</body>
</html>